# mruby on zig

Write in mruby and compile by zig

## Concept and Goals

This is an attempt to write the main program in mruby and compile it by zig to be an executable. Here are the steps to set up the development environment.

### 1. Compile mruby

- Download [mruby](https://mruby.org/). It is currently version 3.4.0.
- Unzip and run `rake test all` to generate headers (mruby.h) and library (libmruby.a) at `mruby-3.4.0/build/host/`.

You can customize the mruby under `build_config` and gembox under `mrbgems`.

### 2. Translate mruby headers

This can be automated by `build.zig`, but it requires some fixes. Therefore, I will do so manually.

- Create a header file, `mruby_headers.h`, to include the necessary headers like this:

```
#include <mruby.h>
#include <mruby/irep.h>

extern uint8_t rb_main[]; // this refers to mruby bytecode in C later
```

- Translate it into zig code:

```
$ zig translate-c -lc -I mruby-3.4.0/build/host/include mruby_headers.h > src/mruby_h.zig
```

### 3. Fix opaque error

Based on [mruby.zig](https://github.com/jethrodaniel/mruby.zig), you need to change this line of generated `src/mruby_h.zig` from:

```
    gc: mrb_gc = @import("std").mem.zeroes(mrb_gc),
```

to this one:

```
    gc: u128 = @import("std").mem.zeroes(u128),
```

### 4. Use build.zig to convert mruby file to bytecode in C automatically

Assuming there is a mruby file at `src/main.rb`. Add this in `build.zig`

```
    // Generate mrb bytecode from src/main.rb
    const mruby_path = "mruby-3.4.0/build/host/";
    const mrbc = b.addSystemCommand(&.{
        mruby_path++"bin/mrbc",
        "-Brb_main", // this "rb_main" is the same as in mruby_headers.h
    });

    const mrb_c = mrbc.addPrefixedOutputFileArg("-o", "main.c");
    mrbc.addFileArg(b.path("src/main.rb"));
```

### 5. Include everything in build.zig

Add the generated bytecode in C to zig executable:

```
    exe.addCSourceFile(.{
        .file = mrb_c,
        .flags = &.{},
    });

    exe.addIncludePath(b.path(mruby_path++"include/"));
    exe.addObjectFile(b.path(mruby_path++"lib/libmruby.a"));
    exe.linkLibC();
    exe.step.dependOn(&mrbc.step);
```

### 6. Run mruby code as executable

The minimal code to run mruby bytecode is:


```
const c = @import("mruby_h.zig");

// This is to fix linking errors
export var edata: u8 = 0;
export var end: u8 = 0;
export var etext: u8 = 0;

pub fn main() !void {
    const mrb = c.mrb_open();
    _ = c.mrb_load_irep(mrb, c.rb_main);
    defer c.mrb_close(mrb);
}
```

And run it with `zig build run`.
